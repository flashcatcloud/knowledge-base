---
title: "告警聚合"
description: "通过告警聚合与抖动检测，有效应对告警风暴"
date: "2024-06-18T10:00:00+08:00"
url: "https://docs.flashcat.cloud/zh/flashduty/noise-reduction-settings"
---

在现代化监控系统中，单一故障往往会引发海量告警（告警风暴）。例如，一台核心数据库宕机，可能会瞬间触发数百条“连接超时”、“CPU 飙升”、“磁盘 I/O 异常”的告警。

Flashduty 的 **告警聚合** 功能，能够将这些相关的告警自动合并为一条故障。这不仅能大幅降低通知频次，还能自动收集故障上下文，帮助运维人员快速定位根因。

## 视频介绍
---
<Video width="200" style="width: 140px;" src="https://download.flashcat.cloud/flashduty/video/alert-aggr.mp4"></Video>

## 配置告警聚合
---

进入 **协作空间详情 => 降噪配置**，即可设置告警聚合策略。建议所有协作空间默认开启此功能。

### 1. 通用配置

这些配置决定了告警聚合的“时间窗口”和“安全底线”。

*   **聚合窗口**：定义了故障聚合的时间范围。
    *   **机制**：以故障**首次发生时间**为起点，在设定的时间窗口内，符合规则的后续告警将被聚合到该故障中。超出窗口的告警将触发新的故障。
    *   **建议**：通常建议设置为 30 至 60 分钟；在智能模式下，默认窗口时间为 30 天，而在规则模式下则为 24 小时。
*   **风暴预警**：防止聚合“掩盖”了严重问题。
    *   **机制**：当单条故障聚合的告警数量超过设定阈值（如 100 条）时，系统会发送特殊的“风暴预警”通知（至多支持5条阈值警告）。
    *   **场景**：提醒您某个故障正在快速恶化，或者当前的聚合规则可能过于宽泛。
*   **严格聚合**：处理“空值”匹配的逻辑。
    *   **开启**：如果告警中缺少聚合维度的标签，则视为“不匹配”，触发新故障。
    *   **关闭**：两个空值视为“相同”，允许聚合。

### 2. 聚合模式

Flashduty 提供两种模式，满足不同场景的需求。

#### A. 智能聚合（省心模式）
系统利用机器学习算法，自动分析告警文本的语义相似度。
*   **原理**：计算告警标题、描述等字段的相似分。
*   **适用场景**：非结构化告警、缺乏标准标签体系的监控系统、或者不想花费精力配置复杂规则的团队。
*   **配置**：您只需指定参与计算的字段（如 Title、Summary），无需定义具体规则。

![2025-12-09-17-11-44](https://docs-cdn.flashcat.cloud/images/png/eab535b1239723a6adc41841013d7b37.png)

#### B. 规则聚合（专家模式）
用户明确定义“哪些告警算作同一类”。这是最常用、最可控的模式。
*   **原理**：基于标签、标题或严重程度等的完全匹配。
*   **配置方式**：
    1.  **统一控制**：全空间生效。例如，选择 `host` 和 `check` 作为聚合维度，那么同一台主机上的同一个检查项报警，永远合并。
    
    ![2025-12-09-17-12-01](https://docs-cdn.flashcat.cloud/images/png/63ff4fb35ef075479a76676b058ecb00.png)

    2.  **细粒度控制**：按条件匹配。例如，“如果是数据库告警，按 `cluster` 聚合；如果是前端告警，按 `service` 聚合”。
    
    ![2025-12-09-17-12-18](https://docs-cdn.flashcat.cloud/images/png/f8e69fbecb54fe52a71dc526134fc7d6.png)

*   **兜底策略**：如果新告警没有匹配任何细粒度规则，将回退到默认维度进行聚合。

## 聚合效果示例
---

设置空间按照 **告警检查项** 进行聚合，系统依次收到5次告警通知，这些通知依次触发了告警和故障：

```
故障：cpu idle < 20% / es.nj.03，Critical

  - 告警cpu idle < 20% / es.nj.03：
      - 事件1：es.nj.03，cpu.idle = 10%，Critical
      - 事件2：es.nj.03，cpu.idle = 18%，Warning
      - 事件4：es.nj.03，cpu.idle = 10%，Ok

  - 告警cpu idle < 20% / es.nj.01：
      - 事件3：es.nj.01，cpu.idle = 15%，Warning
  
  - 告警cpu idle < 20% / es.nj.02：
      - 事件5：es.nj.02，cpu.idle = 19%，Warning
```

我们通过控制台故障详情页，可以看到最终的【故障-告警-事件】关联关系：
- 点击告警标题，您可以查看关联告警的详情，包括告警的时间线和关联事件
- 点击事件点，您可以查看事件上报的具体内容，包括标签和描述

![2025-12-09-17-12-35](https://docs-cdn.flashcat.cloud/images/png/d34e839e2d52e5fa91a426dca032d67e.png)

## 抖动检测
---

**什么是抖动？**
监控数据采集时常会有毛刺，导致告警在短时间内反复触发和恢复。这会产生大量的无效通知（“狼来了”效应）。

只有在相同故障频繁触发与恢复，并且启用了抖动检测的情况下，系统才会将该故障标记为抖动状态。所谓“相同故障”，是指具有相同 Alert Key 的故障。

**Flashduty 的处理机制：**
*   **默认关闭**：不检测故障抖动状态。
*   **仅提醒**：进入抖动状态的故障，会继续按照分配策略进行通知，仅作提醒。
*   **提醒后静默**（推荐）：发现抖动后，自动停止发送后续通知，直到抖动结束。

## 常见问题
---

<details>
  <summary>故障的标题是否会随告警合入改变？</summary>
  不会，默认故障的标题与触发该故障的第一条告警完全相同，您可以在任何时候手动修改故障标题，此标题不会随新告警合入发生变化。
</details>
<details>
  <summary>故障的标签是否会随告警合入改变？</summary>
  
  - 手工创建的告警：不会，其标签列表将永远为空
  - 自动触发的告警：有可能，此时故障的标签将与触发该故障的第一条告警的标签保持一致，如果告警的标签发生变化，那么故障的标签也会同步变化。
</details>
<details>
  <summary>告警的标签是否会随事件合入改变？</summary>
  会的，告警的标签总是与新合入的事件保持一致。比如，如果您10点钟收到一条告警”CPU idle 偏低“，触发值为10%，随着告警合入更多事件，该触发值标签可能会动态变化。但如果新收到的事件，是一条恢复事件，告警将保持已存在的标签不变，并增加之前不存在的标签。我们的原则是，告警展示的标签尽可能保持触发时的样子。
</details>
<details>
  <summary>故障合入的告警数量是否存在上限？</summary>
  存在，我们设置了单个故障最多聚合1000条告警，这主要是为了降低控制台页面的渲染时间。但同时，Flashduty是一个高性能的事件处理系统，后台存在大量并发逻辑，因此当您看到故障聚合超过1000条告警时，这是可能出现的正常现象。
</details>
<details>
  <summary>告警合入的事件数量是否存在上限？</summary>
  不存在。但一个告警聚合事件的窗口最大为24小时。这意味着，如果一个告警触发24小时后还没有恢复，未来也不会合入新的事件。如果Flashduty收到新的事件，会产生新的告警。
</details>
<details>
  <summary>为什么我推送的事件数量和告警关联的事件数量对不上？</summary>
  事件到告警的合并也是一个降噪过程。如果Flashduty认为新上报的事件和告警变化不大（比如状态、严重程度、描述等都没有变化），Flashduty会直接丢弃新上报的事件，并使用新事件的标签来覆盖已有的标签。
</details>
