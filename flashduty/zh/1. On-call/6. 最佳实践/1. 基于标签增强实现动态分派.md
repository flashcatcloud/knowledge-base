---
title: "最佳实践：基于 CMDB 信息的动态分派"
description: "结合标签映射与动态分派，实现无需频繁修改策略的自动化路由"
date: "2025-05-20T10:00:00+08:00"
url: "https://docs.flashcat.cloud/zh/flashduty/best-practice-dynamic-routing"
---

在企业级运维中，我们经常面临这样的挑战：监控对象（主机、服务）成千上万，且对应的负责人经常变动。如果为每个服务都去修改 Flashduty 的分派策略，维护成本将极其高昂。

Flashduty 提供了 **动态分派** 能力，允许通过特定标签（如 `layer_person_reset_0_emails`）直接指定接收人。本文介绍两种实现动态分派的最佳路径。

## 方案一：源系统直接打标
---
如果您拥有监控系统的配置权限，且监控系统支持自定义标签（如 Prometheus、Nightingale、Zabbix），这是最简单的方式。

**操作步骤：**
直接在监控系统的告警规则中，添加符合 Flashduty 规范的标签。

*   **标签键**：`layer_person_reset_0_emails`
*   **标签值**：`bob@corp.com`

**优点**：配置简单，无需在 Flashduty 侧做额外配置。
**缺点**：人员变更时需要修改监控系统的告警规则。

## 方案二：标签映射（适合 CMDB 联动）
---
如果您无法修改监控配置，或者希望将“监控对象”与“负责人”的关系统一管理（类似 CMDB），可以使用 **标签增强** 功能。

此方案通过建立映射表，将监控原本的基础标签（如 `host`）自动“翻译”为 Flashduty 的分派标签。

### 核心原理
1.  **告警接入**：监控系统上报 `host: web-server-01`。
2.  **标签增强**：Flashduty 查表发现 `web-server-01` 对应负责人 `bob@corp.com`，生成中间标签 `layer_person_reset_0_emails`。
3.  **动态分派**：分派系统读取并消费该标签，将告警发给 Bob。
4.  **自动清理**：系统在完成分派指令读取后，会自动移除这些控制类标签，保持告警详情页的整洁。

### 配置步骤

#### 第一步：准备数据
梳理监控对象与负责人的对应关系。如果是小规模数据，可以直接在下一步的页面中手动输入；如果是大规模数据，建议整理为 CSV 文件。

**注意**：CSV 的目标标签必须使用 Flashduty 动态分派的专用参数名。

| host (源标签) | layer_person_reset_0_emails (目标标签) |
| :--- | :--- |
| web-server-01 | bob@corp.com |
| db-server-02 | alice@corp.com |

#### 第二步：创建映射表
将数据录入系统，建立一个可复用的“字典”。

1.  进入 **集成中心 => 标签映射**。
2.  点击 **创建标签映射**。
3.  **录入数据**：
    *   **上传文件**：上传第一步准备的 CSV 文件（适合批量操作）。
    *   **手动输入**：在页面上逐条添加 Key-Value 对（适合少量数据维护）。
4.  保存后，您将获得一个可供集成的映射表对象。

:::tip API 自动化
对于需要实时同步 CMDB 数据的场景，推荐使用 **[Flashduty API](https://developer.flashcat.cloud/flashduty/enrichment/mapping-data-upsert)** 来自动更新映射表内容，实现完全无人值守的配置同步。
:::

#### 第三步：配置增强规则
在具体的告警集成中引用上一步创建的“字典”。

1.  进入 **集成中心 => 标签增强**。
2.  找到您正在使用的告警集成（如 Zabbix 集成），进入详情。
3.  选择 **标签增强** 页签，动作类型选择 **标签映射**。
4.  **选择映射表**：在下拉框中选择 **第二步** 创建的映射表。
5.  **配置关系**：
    *   **源标签**：选择 `host`。
    *   **目标标签**：选择 `layer_person_reset_0_emails`。

这样，系统就会自动根据 `host` 的值查表，并生成对应的分派指令标签。

## 效果验证
---
完成上述任一方案配置后，触发一条测试告警：

1.  **查看分派过程**：在 **故障详情 => 时间线** 中，您会看到类似日志：“基于动态标签，分派对象已重置为 bob@corp.com”。
2.  **检查告警标签**：在告警详情页，您**不会**看到 `layer_person_reset_xxx` 标签。这是正常的，因为这些是控制指令，生效后会被系统自动“消费”并清理，避免干扰视线。
