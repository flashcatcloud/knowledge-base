---
title: "Android RUM SDK 接入指南"
description: "本文档详细介绍如何在 Android 应用中接入 FlashCat RUM SDK。"
date: "2024-05-09T10:00:00+08:00"
url: "https://docs.flashcat.cloud/zh/flashduty/rum/android-sdk-integration"
---

## 概述

FlashCat Android RUM SDK 支持 Android 6.0 (API level 23) 及以上版本。通过集成 SDK，您可以实时监控 Android 应用的性能、错误和用户行为。

## 接入步骤

### 步骤 1：添加 SDK 依赖

在您的应用模块的 `build.gradle` 文件中添加 FlashCat SDK 依赖：

```groovy
dependencies {
    implementation "cloud.flashcat:fc-sdk-android-core:0.1.0"
    implementation "cloud.flashcat:fc-sdk-android-rum:0.1.0"
}
```

### 步骤 2：在 UI 中获取应用信息

在 FlashCat 控制台的 **RUM 应用管理**页面：

1. 创建或选择一个 Android 应用
2. 获取以下信息：
   - **Application ID**：应用唯一标识符
   - **Client Token**：客户端访问令牌
     ![2026-01-14-19-57-20](https://docs-cdn.flashcat.cloud/imges/png/68ee9835732aad09e4e134f30bd2cccd.png)

### 步骤 3：使用应用上下文初始化 SDK

在您的 `Application` 类的 `onCreate()` 方法中初始化 FlashCat SDK：

```kotlin
import cloud.flashcat.android.Flashcat
import cloud.flashcat.android.FlashcatSite
import cloud.flashcat.android.core.configuration.Configuration
import cloud.flashcat.android.privacy.TrackingConsent

class SampleApplication : Application() {
    override fun onCreate() {
        super.onCreate()

        val clientToken = "<CLIENT_TOKEN>"
        val environmentName = "<ENV_NAME>"
        val appVariantName = "<APP_VARIANT_NAME>"

        val configuration = Configuration.Builder(
            clientToken = clientToken,
            env = environmentName,
            variant = appVariantName
        )
            .build()

        Flashcat.initialize(this, configuration, TrackingConsent.GRANTED)
    }
}
```

```java
import cloud.flashcat.android.Flashcat;
import cloud.flashcat.android.FlashcatSite;
import cloud.flashcat.android.core.configuration.Configuration;
import cloud.flashcat.android.privacy.TrackingConsent;

public class SampleApplication extends Application {
    @Override
    public void onCreate() {
        super.onCreate();

        String clientToken = "<CLIENT_TOKEN>";
        String environmentName = "<ENV_NAME>";
        String appVariantName = "<APP_VARIANT_NAME>";

        Configuration configuration = new Configuration.Builder(clientToken, environmentName, appVariantName)
                .build();

        Flashcat.initialize(this, configuration, TrackingConsent.GRANTED);
    }
}
```

在初始化时，需要设置环境名称（`environmentName`）和应用变体名称（`appVariantName`）。`appVariantName` 用于指定生成数据的应用变体。关于更多配置选项，请参阅 [高级配置](https://docs.flashcat.cloud/zh/flashduty/rum/android-advanced-configuration)。

### 步骤 4：启用 RUM 功能并开始发送数据

配置并启用 Android SDK 的 RUM 功能：

```kotlin
import cloud.flashcat.android.rum.Rum
import cloud.flashcat.android.rum.RumConfiguration
import cloud.flashcat.android.rum.tracking.ActivityViewTrackingStrategy

val rumConfig = RumConfiguration.Builder(applicationId)
    .trackUserInteractions()
    .trackLongTasks(durationThreshold)
    .useViewTrackingStrategy(ActivityViewTrackingStrategy(true))
    .build()
Rum.enable(rumConfig)
```

```java
import cloud.flashcat.android.rum.Rum;
import cloud.flashcat.android.rum.RumConfiguration;
import cloud.flashcat.android.rum.tracking.ActivityViewTrackingStrategy;

RumConfiguration rumConfig = new RumConfiguration.Builder(applicationId)
    .trackUserInteractions()
    .trackLongTasks(durationThreshold)
    .useViewTrackingStrategy(new ActivityViewTrackingStrategy(true))
    .build();
Rum.enable(rumConfig);
```

### 步骤 5：初始化拦截器以追踪网络事件

要初始化用于追踪网络事件的拦截器：

1. **启用链路追踪功能**：添加并启用 Trace 功能
2. **添加依赖**：在模块级 `build.gradle` 文件中添加 `fc-sdk-android-okhttp` 库依赖：

```groovy
dependencies {
    implementation "cloud.flashcat:fc-sdk-android-okhttp:0.1.0"
}
```

3. **添加拦截器**：配置 FlashCat 提供的拦截器以追踪 OkHttp 请求：

```kotlin
import cloud.flashcat.android.okhttp.FlashcatInterceptor
import cloud.flashcat.android.okhttp.trace.TracingHeaderType

val tracedHostsWithHeaderType = mapOf(
    "example.com" to setOf(
        TracingHeaderType.FLASHCAT,
        TracingHeaderType.TRACECONTEXT
    ),
    "api.example.com" to setOf(
        TracingHeaderType.FLASHCAT,
        TracingHeaderType.TRACECONTEXT
    )
)

val okHttpClient = OkHttpClient.Builder()
    .addInterceptor(FlashcatInterceptor.Builder(tracedHostsWithHeaderType).build())
    .build()
```

```java
import cloud.flashcat.android.okhttp.FlashcatInterceptor;
import cloud.flashcat.android.okhttp.trace.TracingHeaderType;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

Map<String, Set<TracingHeaderType>> tracedHostsWithHeaderType = new HashMap<>();
Set<TracingHeaderType> headerTypes = new HashSet<>();
headerTypes.add(TracingHeaderType.FLASHCAT);
headerTypes.add(TracingHeaderType.TRACECONTEXT);
tracedHostsWithHeaderType.put("example.com", headerTypes);
tracedHostsWithHeaderType.put("api.example.com", headerTypes);

OkHttpClient okHttpClient = new OkHttpClient.Builder()
    .addInterceptor(new FlashcatInterceptor.Builder(tracedHostsWithHeaderType).build())
    .build();
```

4. **自动创建资源和 Span**：使用 `FlashcatInterceptor` 作为拦截器后，OkHttpClient 处理的每个请求都会被自动记录为资源，相关信息（URL、方法、状态码、错误）会自动填充。**注意**：只有在视图处于活动状态时发起的网络请求才会被追踪。要追踪应用在后台时的请求，请参阅 [追踪后台事件](#追踪后台事件)。

5. **追踪网络重定向或重试**：要监控网络重定向或重试，可以将 `FlashcatInterceptor` 用作网络拦截器：

```kotlin
val okHttpClient = OkHttpClient.Builder()
    .addNetworkInterceptor(FlashcatInterceptor.Builder(tracedHostsWithHeaderType).build())
    .build()
```

```java
OkHttpClient okHttpClient = new OkHttpClient.Builder()
    .addNetworkInterceptor(new FlashcatInterceptor.Builder(tracedHostsWithHeaderType).build())
    .build();
```

**注意**：

- 如果使用多个拦截器，请将 `FlashcatInterceptor` 添加为第一个拦截器

您还可以为 `OkHttpClient` 添加 `EventListener`，以自动追踪第三方提供商和网络请求的资源时序。

#### 过滤特定错误

要过滤 `FlashcatInterceptor` 报告的特定错误，可以在 `RumConfiguration` 中配置自定义 `EventMapper`：

```kotlin
val rumConfig = RumConfiguration.Builder(applicationId)
    .setErrorEventMapper { errorEvent ->
        if (errorEvent.shouldBeDiscarded()) {
            null
        } else {
            errorEvent
        }
    }
    .build()
```

```java
RumConfiguration rumConfig = new RumConfiguration.Builder(applicationId)
    .setErrorEventMapper(errorEvent -> {
        if (errorEvent.shouldBeDiscarded()) {
            return null;
        } else {
            return errorEvent;
        }
    })
    .build();
```

## 追踪后台事件

您可以追踪应用在后台运行时的事件（例如崩溃和网络请求）。

在配置时添加以下代码：

```kotlin
val rumConfig = RumConfiguration.Builder(applicationId)
    // ...
    .trackBackgroundEvents(true)
    .build()
```

```java
RumConfiguration rumConfig = new RumConfiguration.Builder(applicationId)
    // ...
    .trackBackgroundEvents(true)
    .build();
```

**注意**：追踪后台事件可能会产生额外的会话，从而影响计费。如有疑问，请联系 FlashCat 支持团队。

## 设备离线时发送数据

Android SDK 确保在用户设备离线时的数据可用性。在网络信号弱或设备电量过低的情况下，所有事件首先以批次形式存储在本地设备上。

每个批次都遵循数据接收规范。只要网络可用且电量充足，批次就会被发送，以确保 FlashCat SDK 不会影响最终用户的体验。如果应用在前台运行时网络不可用，或者数据上传失败，批次会被保留，直到成功发送为止。

这意味着即使用户在离线时打开您的应用，也不会丢失数据。为了确保 SDK 不会占用过多磁盘空间，磁盘上过旧的数据会被自动丢弃。

### 追踪本地资源访问

您可以使用 `getAssetAsRumResource` 扩展方法追踪 assets 资源的访问：

```kotlin
val inputStream = context.getAssetAsRumResource(fileName)
```

使用 `getRawResAsRumResource` 扩展方法追踪 raw 资源的使用：

```kotlin
val inputStream = context.getRawResAsRumResource(id)
```

## WebView 集成

如果您的 Android 应用中包含 WebView，可以通过以下方式启用 WebView 追踪：

### 添加 WebView 依赖

```groovy
dependencies {
    implementation "cloud.flashcat:fc-sdk-android-webview:0.1.0"
}
```

### 启用 WebView 追踪

在您的 Activity 或 Fragment 中启用 WebView 追踪：

```kotlin
import cloud.flashcat.android.webview.WebViewTracking

// Enable tracking for the specified WebView
WebViewTracking.enable(webView, listOf("example.com", "*.example.com"))
```

**参数说明：**

- `webView`: 需要追踪的 WebView 实例
- `allowedHosts`: 允许追踪的域名列表，支持通配符

这样，您的 WebView 中的 Web 页面就可以与原生应用的 RUM 数据关联起来。

## 验证接入

接入完成后，您可以通过以下步骤验证是否接入成功：

1. **访问控制台**：登录 FlashCat 控制台，进入对应的 RUM 应用，查看是否有数据上报
2. **触发测试事件**：
   - 打开应用的不同页面，验证页面浏览事件
   - 执行一些用户操作（点击、滑动等），验证交互事件
   - 触发网络请求，验证资源加载事件
3. **查看数据上报地址**：在 Logcat 中查看是否有向数据上报端点的网络请求

## 混淆配置

如果您的应用启用了代码混淆（ProGuard/R8），请在 `proguard-rules.pro` 文件中添加以下规则：

```proguard
# FlashCat SDK
-keep class cloud.flashcat.android.** { *; }
-dontwarn cloud.flashcat.android.**
```

## 更多阅读

- [RUM 应用管理](https://docs.flashcat.cloud/zh/flashduty/rum/application-management)：了解如何创建和管理 RUM 应用
- [Android SDK 高级配置](https://docs.flashcat.cloud/zh/flashduty/rum/android-advanced-configuration)：了解如何配置 SDK 的高级功能
- [RUM 分析看板](https://docs.flashcat.cloud/zh/flashduty/rum/native/analysis-dashboard)：查看和分析 RUM 数据
