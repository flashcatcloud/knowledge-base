---
title: "FlashCat RUM 性能指标收集与上报"
description: "了解 FlashCat RUM 性能指标的收集方法、上报机制及配置说明。"
date: "2024-05-09T10:00:00+08:00"
url: "https://docs.flashcat.cloud/zh/flashduty/rum/performance-metrics-reporting"
---

## 指标计算方法

### 1. 最大内容绘制（LCP）

- **计算**: 从页面开始加载（`navigationStart`）到最大可见内容元素（如图片、文本块）渲染完成的时间。
- **用例**: 监控主页或关键页面内容加载速度，识别资源加载瓶颈。

### 2. 首次输入延迟（FID）

- **计算**: 从用户交互开始到浏览器处理事件的时间差。
- **用例**: 优化交互密集型页面（如表单、导航菜单）的响应速度。

### 3. 累计布局偏移（CLS）

- **计算**: 统计所有意外布局偏移的分数（偏移距离 × 影响区域）。
- **用例**: 识别动态内容或广告导致的页面跳动问题。

### 4. 页面加载时间

- **传统多页面应用**:
  - 计算 `navigationStart` 到 `loadEventEnd` 的时间差，或到页面首次无活动状态的时间差，取较大值。
- **单页面应用（SPA）**:
  - 计算 URL 变更到页面首次无活动状态的时间差。
- **用例**: 评估整体页面加载体验，识别慢加载页面。

## 页面活动状态判定

### 1. 活动状态判定标准

页面处于"活动状态"时，存在以下任一情况：

- 进行中的 XHR 或 Fetch 请求。
- 浏览器触发资源加载事件（如 JS、CSS 加载）。
- 浏览器触发 DOM 变更事件。

### 2. 活动结束判定

页面连续 100ms 无任何活动时，判定为"无活动状态"。

### 3. 特殊场景处理

以下场景可能干扰活动状态判定：

- 定期发送的分析数据请求。
- 长轮询或流式传输请求。

**解决方案**: 使用 `excludedActivityUrls` 配置排除特定请求：

```javascript
window.DD_RUM.init({
  excludedActivityUrls: [
    "https://analytics-api.example.com/collect", // 精确 URL
    /\/streaming$/, // 正则匹配
    (url) => url.includes("analytics"), // 自定义函数
  ],
});
```

## 自定义性能监控

### 1. 组件级性能测量

使用 `customVital` API 监控特定组件或交互的性能，适用于：

- 关键组件渲染时间。
- 用户交互响应时间。
- 业务流程耗时。

#### 示例：测量组件渲染

```javascript
// 开始计时
const ref = window.DD_RUM.startDurationVital("componentRendering", {
  description: "login-form",
  context: { clientId: "xxx", componentVersion: "1.0.0" },
});

// 结束计时
window.DD_RUM.stopDurationVital(ref);
```

#### 示例：直接报告耗时

```javascript
window.DD_RUM.addDurationVital("dropdownRendering", {
  startTime: 1707755888000, // UNIX 时间戳（毫秒）
  duration: 10000, // 耗时（毫秒）
});
```

### 2. 性能时间点记录

使用 `addTiming` API 记录关键时间点，适用于：

- 关键元素加载（如首屏图片）。
- 用户首次交互（如首次滚动）。
- 业务节点时间戳。

#### 示例：记录首次滚动

```javascript
document.addEventListener("scroll", function handler() {
  document.removeEventListener("scroll", handler);
  window.DD_RUM.addTiming("first_scroll");
});
```

#### 示例：异步场景

```javascript
document.addEventListener("scroll", function handler() {
  document.removeEventListener("scroll", handler);
  const timing = Date.now();
  window.DD_RUM.onReady(() => {
    window.DD_RUM.addTiming("first_scroll", timing);
  });
});
```

## 数据查询与分析

### 1. 自定义指标查询

- `@vital.name:指标名称`：筛选特定指标。
- `@vital.duration:>数值`：筛选耗时。
- `@vital.description:描述`：过滤场景。

### 2. 时间点查询

- 使用 `@view.custom_timings.时间点名称` 访问时间点数据（单位：纳秒）。
- 支持在 RUM Explorer 和仪表板中可视化。

## 注意事项

### 1. 命名规范

- 指标名称避免空格、特殊字符。
- 使用描述性命名（如 `login_form_render`）。
- 保持命名一致性。

### 2. SPA 场景处理

- 路由变更时，计时以当前 RUM view 的开始时间为基准。
- 需要重置某些计时器。
- 注意页面切换时的指标连续性。

### 3. 性能影响控制

- 控制自定义指标数量。
- 避免频繁计时。
- 合理设置采样率。

## 常见问题

### 1. 页面加载时间异常

- 检查慢加载资源（图片、脚本）。
- 排查第三方脚本阻塞。
- 分析长时间运行的 JavaScript。

### 2. 活动状态判定不准确

- 确认是否存在频繁的后台请求。
- 检查长连接或流式请求的处理。
- 使用 `excludedActivityUrls` 排除干扰。

### 3. 自定义指标问题

- 验证指标名称是否符合规范。
- 确保计时器正确启停。
- 检查异步场景的时间戳准确性。

## 下一步

- [实施性能优化最佳实践](../2. 最佳实践/3. 性能优化.md)

---
