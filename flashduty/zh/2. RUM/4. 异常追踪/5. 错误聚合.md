---
title: "RUM 错误聚合"
description: "了解 FlashCat RUM 的错误聚合机制，提高问题定位效率。"
date: "2024-05-09T10:00:00+08:00"
url: "https://docs.flashcat.cloud/zh/flashduty/rum/error-aggregation"
---

## 错误聚合

### 异常聚合的工作原理

FlashCat 异常聚合会将具有相同根本原因的错误事件分组为一个问题。聚合基于以下因素：

- **错误消息**：相同或相似的错误消息会被视为同一问题。
- **堆栈跟踪**：堆栈帧的相似性（包括文件名、函数名、行号和列号）是分组的关键依据。
- **上下文信息**：如浏览器类型、用户位置、应用版本等元数据可能影响分组。
- **自定义指纹**：开发者可以通过自定义规则进一步控制分组逻辑。

当新错误发生时，FlashCat 会与现有问题进行匹配：

- 如果错误消息相同，或堆栈顶部帧及后续 3 个中的 4 个帧匹配，则归入现有问题。
- 如果不匹配，则创建新的问题组。

### 配置异常聚合

#### 自动聚合

FlashCat 默认启用异常聚合，无需额外配置即可开始工作。Browser SDK 会自动收集错误数据并进行分组。以下是 Web 环境下的基本设置：

1. **集成 FlashCat Browser SDK**

   在 HTML 文件中引入 FlashCat Browser SDK：

   ```html
   <script src="https://cdn.flashcat.com/rum-browser-sdk.js"></script>
   ```

2. **初始化 SDK**

   初始化 SDK 时，指定应用 ID 和环境：

   ```javascript
   window.FLASHCAT_RUM.init({
     applicationId: "rum-application-id",
     environment: "production",
     version: "1.0.0",
   });
   ```

#### 自定义分组

若默认分组无法满足需求，可以通过自定义指纹实现更精细的控制。以下是 Web 环境下的配置方法：

1. **手动添加自定义指纹**

   在手动报告错误时，通过 `addError` 添加自定义指纹：

   ```javascript
   window.FLASHCAT_RUM.addError(new Error("My error message"), {
     source: "custom",
     fingerprint: "my-custom-grouping-fingerprint",
   });
   ```

2. **使用 beforeSend 回调**

   通过 `beforeSend` 回调动态设置指纹：

   ```javascript
   window.FLASHCAT_RUM.init({
     applicationId: "rum-application-id",
     environment: "production",
     beforeSend: (event) => {
       if (event.type === "error") {
         event.error.fingerprint = "my-custom-grouping-fingerprint";
       }
       return true;
     },
   });
   ```

   **注意**：

   - 自定义指纹必须为字符串类型。
   - `beforeSend` 回调还可用于过滤无关错误（如第三方脚本错误）。

#### Web 特定注意事项

- **SourceMap 集成**：

  - 上传 `sourcemap` 文件以解码压缩后的堆栈跟踪，确保聚合后的错误堆栈可映射到原始源代码。
  - 示例：使用 `flashcat-cli` 上传 `sourcemap`：
    ```bash
    flashcat-cli sourcemaps upload --service my-service --release-version 1.0.0 --minified-path-prefix /assets --api-key your-api-key ./dist
    ```

- **第三方脚本错误**：
  - 默认情况下，FlashCat 会过滤来自浏览器扩展或第三方脚本的错误（如 `network` 来源），以减少噪声。
  - 可通过 `beforeSend` 进一步自定义过滤规则：
    ```javascript
    beforeSend: (event) => {
      if (
        event.error.source === "network" &&
        event.error.message.includes("ThirdPartyScript")
      ) {
        return false; // 丢弃该错误
      }
      return true;
    };
    ```

### 查看和分析聚合结果

1. **异常追踪页面**

   在 FlashCat 平台，导航至 **数字体验 > 异常追踪**，查看聚合后的问题列表。每个问题包含：

   - 错误消息和堆栈跟踪（若上传了 `sourcemap`，会显示原始源代码位置）。
   - 用户会话时间线。
   - 元数据（如浏览器类型、版本号）。

2. **过滤和分组**

   使用查询功能按 `@error.message`、`@error.type` 或自定义属性过滤问题。支持按环境、版本等属性分组。

   示例查询：

   ```plaintext
   @error.message:"My error message" @source:custom
   ```

3. **监控设置**

   创建监控以实时跟踪问题：

   - **新问题监控**：检测 `For Review` 状态下的新问题。
   - **高影响监控**：关注 `For Review` 或 `Reviewed` 状态下影响较大的问题。

   示例查询：

   ```plaintext
   error-tracking("@error.message:My error message").source("web").new().last("1d") > 0
   ```
