---
title: "SLS (Aliyun Log Service) 告警规则配置说明"
description: "本文档详细介绍如何在 Monitors 告警引擎中配置阿里云日志服务 (SLS) 数据源的告警规则。Monitors 支持使用标准 SQL 语法对 SLS 进行查询，并根据查询结果触发告警。"
date: "2025-12-30T18:21:50.775+08:00"
url: "https://docs.flashcat.cloud/zh/flashduty/monitors/sls-alert-rules"
---

本文档详细介绍如何在 Monitors 告警引擎中配置阿里云日志服务 (SLS) 数据源的告警规则。Monitors 通过 SLS 的 SQL 查询接口（GetLogsV3）获取数据，并根据查询结果触发告警。

## 核心概念

*   **查询语言**：使用 SLS SQL 语法。
*   **必填参数**：每条查询语句都必须指定 `sls.project` 和 `sls.logstore` 参数。
*   **时间范围**：SLS 的查询时间范围由 API 参数控制（通过 `sls.timespan` 配置），**不需要**在 SQL 语句中写 `WHERE __time__ > ...`。
*   **字段处理**：
    *   默认情况下，`__source__` 和 `__time__` 字段会被忽略（除非显式指定为值字段）。

---

## 1. 阈值判定模式 (Threshold)

此模式适用于需要对聚合后的数值进行阈值比对的场景。

### 配置方式

1.  **查询语句 (SQL)**：编写 SLS SQL 聚合查询。
    *   *示例*：统计最近 15 分钟内，各主机的错误日志数量。
        ```sql
        * | SELECT host, count(*) as error_cnt WHERE level = 'ERROR' GROUP BY host
        ```
2.  **查询参数 (Args)**：
    *   `sls.project`: (必填) 项目名称。
    *   `sls.logstore`: (必填) 日志库名称。
    *   `sls.timespan.value`: (选填) 时间跨度数值，默认为 15。
    *   `sls.timespan.unit`: (选填) 时间跨度单位，支持 `s` (秒), `m` (分), `h` (时), `d` (天)。默认为 `m`。
3.  **字段映射**：
    *   **标签字段 (Label Fields)**：用于区分不同告警对象的字段。上例中为 `host`。该字段可以留空，Monitors 会自动把除了值字段外的所有字段都作为标签字段。
    *   **值字段 (Value Fields)**：用于阈值判定的数值字段。上例中为 `error_cnt`。
4.  **阈值条件**：
    *   使用 `$A.field_name` 引用数值。
    *   *示例*：`Critical: $A.error_cnt > 50`，`Warning: $A.error_cnt > 10`。

### 工作原理
引擎调用 SLS API，指定时间范围（如最近 15 分钟），执行 SQL 查询。获取结果后，根据“标签字段”分组，提取“值字段”与阈值比对。

### 恢复逻辑
*   **自动恢复**：当最新的查询结果中，数值不再满足任何告警阈值时，自动恢复。
*   **特定恢复条件**：配置额外的恢复表达式（如 `$A.error_cnt < 5`）。
*   **恢复查询 (Recovery Query)**：
    *   支持配置独立的 SQL 语句用于恢复判定。
    *   支持 `${label_name}` 变量替换。
    *   *示例*：告警 SQL 查出了 `network_host="a", interface="b"` 的网卡挂了。恢复 SQL 可以写：
        ```sql
        * | SELECT count(*) as cnt WHERE network_host = '${network_host}' AND interface = '${interface}' AND status = 'UP'
        ```
        *   引擎会将 `${network_host}` 和 `${interface}` 替换为实际值后执行查询，如果查到数据，则判定恢复。

---

## 2. 数据存在模式 (Data Exists)

此模式适用于将过滤逻辑直接写在 SQL 中的场景。

### 配置方式

1.  **查询语句 (SQL)**：使用 `HAVING` 子句过滤异常数据。
    *   *示例*：查询错误数超过 50 的主机。
        ```sql
        * | SELECT host, count(*) as error_cnt WHERE level = 'ERROR' GROUP BY host HAVING error_cnt > 50
        ```
2.  **查询参数**：同上，需配置 `sls.project` 和 `sls.logstore`。
3.  **判定规则**：只要查询返回了数据，即触发告警。

### 优缺点分析
*   **优点**：利用 SLS 服务端的计算能力，减少数据传输。
*   **缺点**：无法区分多级告警。

### 恢复逻辑
*   **数据消失即恢复**：当查询结果为空时，判定恢复。
*   **恢复查询**：支持配置额外的查询语句。

---

## 3. 数据缺失模式 (No Data)

此模式用于监控“预期应该有数据，但实际没有数据”的场景。

### 配置方式

1.  **查询语句 (SQL)**：编写一个预期应该持续返回数据的查询。
    *   *示例*：查询所有主机的日志上报心跳。
        ```sql
        * | SELECT host, max(__time__) as last_seen GROUP BY host
        ```
2.  **判定规则**：如果某个 `host` 在之前的周期中出现过，但在当前及连续 N 个周期中查不到数据，则触发“数据缺失”告警。

---

## 4. 高级配置与最佳实践

### Power SQL
如果需要使用 SLS 的增强 SQL 语法，可以在查询参数中添加：
*   `sls.powersql`: `true`

### 时间范围控制
默认查询最近 15 分钟的数据。可以通过参数调整：
*   `sls.timespan.value`: `60`
*   `sls.timespan.unit`: `m`
*   *注意*：不要在 SQL 中使用 `__time__` 进行过滤，除非你有特殊需求。引擎会自动根据上述参数设置 API 请求的 `from` 和 `to` 时间戳。

### 调试参数
如果需要调试特定时间段的数据，可以使用以下参数（通常仅用于调试，不要配置在生产规则中）：
*   `sls.from`: 开始时间戳（秒）。
*   `sls.to`: 结束时间戳（秒）。
