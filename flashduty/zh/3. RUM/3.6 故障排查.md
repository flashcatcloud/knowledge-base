---
title: "RUM 故障排查"
description: "了解如何排查FlashCat实时用户监控(RUM)的常见问题并确保最佳数据收集。"
date: "2024-05-09T10:00:00+08:00"
url: "https://docs.flashcat.cloud/zh/flashduty/rum/troubleshooting"
---

## 概述
---

本指南帮助您排查FlashCat实时用户监控(RUM)的常见问题，并确保您的RUM实施正常工作。它涵盖数据收集问题、SDK配置问题和性能问题。

## 验证数据收集
---

如果您在RUM仪表板中看不到数据，请按照以下步骤验证数据收集：

### 检查SDK安装

1. **验证脚本包含**：确保RUM SDK脚本正确包含在您的HTML中：

   ```html
   <!-- 自动检测 -->
   <script>
     (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'rum.start':
     new Date().getTime(),event:'rum',
     'application_id':'YOUR_APPLICATION_ID',
     'client_token':'YOUR_CLIENT_TOKEN'
     });var f=d.getElementsByTagName(s)[0],
     j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
     'https://cdn.flashcat.cloud/rum.js';f.parentNode.insertBefore(j,f);
     })(window,document,'script','fcLayer','YOUR_APPLICATION_ID');
   </script>
   ```

   或者手动检测：

   ```javascript
   import { RumBrowser } from '@flashcat/rum-browser';

   RumBrowser.init({
     applicationId: 'YOUR_APPLICATION_ID',
     clientToken: 'YOUR_CLIENT_TOKEN',
     // 其他配置选项
   });
   ```

2. **检查控制台错误**：打开浏览器的开发者控制台，查找与RUM SDK相关的JavaScript错误。

3. **验证应用程序ID和客户端令牌**：确保您使用的是FlashCat控制台中的正确应用程序ID和客户端令牌。

### 检查网络请求

1. 打开浏览器的开发者工具并转到网络选项卡。
2. 过滤`rum-intake.flashcat.cloud`的请求。
3. 验证请求是否被发送并接收200 OK响应。
4. 如果请求失败，检查响应中的错误消息。

### 检查浏览器兼容性

确保您使用的是受支持的浏览器。FlashCat RUM支持：

- Chrome 60+
- Firefox 60+
- Safari 12+
- Edge 15+
- Internet Explorer 11（有限制）

### 检查广告拦截器

一些广告拦截器可能会阻止RUM SDK。尝试禁用广告拦截器或为您的域名和`rum-intake.flashcat.cloud`添加例外。

## 常见问题和解决方案
---

### 仪表板中没有数据

**问题**：您已实施RUM SDK，但仪表板中没有显示数据。

**解决方案**：

1. **等待几分钟**：数据可能需要最多5分钟才能出现在仪表板中。

2. **检查初始化**：确保RUM SDK在任何用户交互发生之前正确初始化。

3. **验证采样率**：检查您是否配置了过低的采样率：

   ```javascript
   RumBrowser.init({
     // ... 其他配置选项
     sampleRate: 100 // 确保这设置为100以获取完整数据收集
   });
   ```

4. **检查同意管理**：如果您使用同意管理，确保跟踪同意已授予：

   ```javascript
   RumBrowser.setTrackingConsent('granted');
   ```

### 缺失用户行为

**问题**：用户行为未被跟踪或不完整。

**解决方案**：

1. **启用用户交互跟踪**：确保用户交互跟踪已启用：

   ```javascript
   RumBrowser.init({
     // ... 其他配置选项
     trackUserInteractions: true
   });
   ```

2. **检查行为命名**：对于自定义元素，确保它们有适当的属性用于行为命名：

   ```html
   <button data-action-name="提交表单">提交</button>
   ```

3. **使用自定义行为跟踪**：对于复杂交互，使用自定义行为跟踪：

   ```javascript
   RumBrowser.addAction('click', '自定义按钮点击');
   ```

### 缺失错误数据

**问题**：JavaScript错误未被捕获。

**解决方案**：

1. **启用错误跟踪**：确保错误跟踪已启用：

   ```javascript
   RumBrowser.init({
     // ... 其他配置选项
     trackErrors: true
   });
   ```

2. **检查错误处理**：确保您的错误处理不会阻止错误到达RUM SDK：

   ```javascript
   // 不要这样做：
   try {
     // 可能抛出错误的代码
   } catch (error) {
     console.error(error);
     // 错误被捕获但未报告给RUM
   }

   // 应该这样做：
   try {
     // 可能抛出错误的代码
   } catch (error) {
     console.error(error);
     RumBrowser.addError(error);
   }
   ```

3. **检查源映射**：如果您使用压缩代码，确保源映射正确配置以获得更好的错误报告。

### 性能影响问题

**问题**：关于RUM SDK影响应用程序性能的担忧。

**解决方案**：

1. **优化配置**：禁用您不需要的功能：

   ```javascript
   RumBrowser.init({
     // ... 其他配置选项
     trackResources: true,
     trackLongTasks: true,
     trackErrors: true,
     trackUserInteractions: true
   });
   ```

2. **调整采样率**：减少采样率，只从一部分用户收集数据：

   ```javascript
   RumBrowser.init({
     // ... 其他配置选项
     sampleRate: 50 // 从50%的用户收集数据
   });
   ```

3. **明智使用会话回放**：会话回放可能会消耗资源。考虑为会话回放使用较低的采样率：

   ```javascript
   RumBrowser.init({
     // ... 其他配置选项
     replaySampleRate: 10 // 为10%的会话记录会话回放
   });
   ```

### 内容安全策略(CSP)问题

**问题**：CSP阻止RUM SDK加载或发送数据。

**解决方案**：

1. **更新脚本源CSP**：允许从FlashCat CDN加载脚本：

   ```
   script-src 'self' https://cdn.flashcat.cloud;
   ```

2. **更新连接源CSP**：允许向FlashCat intake发送数据：

   ```
   connect-src 'self' https://rum-intake.flashcat.cloud;
   ```

3. **更新工作源CSP**（如果使用会话回放）：

   ```
   worker-src 'self' blob:;
   ```

### 单页应用程序(SPA)问题

**问题**：页面视图在SPA中未正确跟踪。

**解决方案**：

1. **手动视图跟踪**：对于SPA，手动跟踪视图更改：

   ```javascript
   // 当SPA中的路由更改时
   RumBrowser.startView({
     name: '产品页面',
     url: '/products/123'
   });
   ```

2. **框架集成**：使用特定框架的集成：

   对于React Router：
   ```javascript
   import { useEffect } from 'react';
   import { useLocation } from 'react-router-dom';

   function RumRouteTracker() {
     const location = useLocation();

     useEffect(() => {
       RumBrowser.startView({
         name: location.pathname,
         url: location.pathname + location.search
       });
     }, [location]);

     return null;
   }
   ```

   对于Vue Router：
   ```javascript
   router.afterEach((to) => {
     RumBrowser.startView({
       name: to.name || to.path,
       url: to.path + to.fullPath.substring(to.path.length)
     });
   });
   ```

## 高级故障排查
---

### 调试模式

启用调试模式在浏览器控制台获取详细日志：

```javascript
RumBrowser.init({
  // ... 其他配置选项
  debug: true
});
```

这将记录有关SDK初始化、数据收集和遇到的任何问题的详细信息。

### 手动会话记录

如果您需要强制记录会话进行测试：

```javascript
RumBrowser.init({
  // ... 其他配置选项
  forceSessionReplay: true
});
```

### 网络请求检查

要检查发送到FlashCat的确切数据：

1. 打开浏览器开发者工具
2. 转到网络选项卡
3. 过滤`rum-intake.flashcat.cloud`的请求
4. 点击请求并查看"请求"选项卡以查看负载

### 浏览器控制台命令

FlashCat RUM向浏览器控制台添加一些调试命令：

```javascript
// 获取当前RUM上下文
window._fcRum.getInternalContext();

// 获取当前会话ID
window._fcRum.getCurrentSessionId();

// 获取当前视图ID
window._fcRum.getCurrentViewId();
```

## 联系支持
---

如果您尝试了上述故障排查步骤但仍然遇到问题，请联系FlashCat支持：

1. 收集以下信息：
   - 您的应用程序ID
   - 浏览器和版本
   - SDK版本
   - 控制台错误（如有）
   - 网络请求日志
   - 重现问题的步骤

2. 通过以下渠道联系支持：
   - 电子邮件：support@flashcat.cloud
   - 支持门户：https://support.flashcat.cloud
   - 应用内聊天：点击FlashCat控制台中的"帮助"按钮

## 常见问题
---

### 问：数据需要多长时间才能出现在仪表板中？

答：数据通常在收集后2-5分钟内出现在仪表板中。在高流量期间，可能需要稍长时间。

### 问：RUM SDK是否适用于移动浏览器？

答：是的，RUM SDK适用于iOS和Android上的现代移动浏览器。但是，会话回放等某些功能在移动设备上可能有限制。

### 问：如何从RUM跟踪中排除某些页面？

答：您可以根据当前URL有条件地初始化RUM SDK：

```javascript
if (!window.location.pathname.startsWith('/admin')) {
  RumBrowser.init({
    // ... 配置选项
  });
}
```

### 问：如何跟踪多个域名之间的用户？

答：要跟踪多个域名之间的用户，您需要：

1. 在所有域名上使用相同的应用程序ID和客户端令牌
2. 在域名之间设置一致的用户ID
3. 启用跨域跟踪：

```javascript
RumBrowser.init({
  // ... 其他配置选项
  allowedTracingOrigins: [
    'https://example.com',
    'https://app.example.com',
    'https://shop.example.com'
  ]
});
```

### 问：如何减少收集的数据量？

答：您可以通过以下方式减少数据收集：

1. 降低采样率
2. 禁用您不需要的功能
3. 排除某些页面或用户细分
4. 配置隐私设置以掩盖敏感数据

通过遵循这些故障排查步骤，您可以确保FlashCat RUM正确配置并收集您需要的数据，以监控和改善Web应用程序的性能和用户体验。
